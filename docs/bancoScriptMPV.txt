DROP DATABASE IF EXISTS `mathmagic` ;
CREATE DATABASE IF NOT EXISTS `mathmagic` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci ;
USE `mathmagic` ;

CREATE TABLE IF NOT EXISTS `admin` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `email` VARCHAR(120) NOT NULL UNIQUE,
  `senha` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `trilha` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `descricao` TEXT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `jogo` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `descricao` TEXT NULL,
  `trilha_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_jogo_trilha_idx` (`trilha_id` ASC) VISIBLE,
  CONSTRAINT `fk_jogo_trilha`
    FOREIGN KEY (`trilha_id`)
    REFERENCES `trilha` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `professor` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `email` VARCHAR(120) NOT NULL UNIQUE,
  `senha` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `sala` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `professor_id` INT NOT NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_sala_professor_idx` (`professor_id` ASC) VISIBLE,
  CONSTRAINT `fk_sala_professor`
    FOREIGN KEY (`professor_id`)
    REFERENCES `professor` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `aluno` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `nome` VARCHAR(80) NOT NULL,
  `email` VARCHAR(120) NOT NULL UNIQUE,
  `senha` VARCHAR(255) NOT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `aluno_sala` (
  `aluno_id` INT NOT NULL,
  `sala_id` INT NOT NULL,
  PRIMARY KEY (`aluno_id`, `sala_id`),
  INDEX `fk_aluno_sala_aluno_idx` (`aluno_id` ASC) VISIBLE,
  INDEX `fk_aluno_sala_sala_idx` (`sala_id` ASC) VISIBLE,
  CONSTRAINT `fk_aluno_sala_aluno`
    FOREIGN KEY (`aluno_id`)
    REFERENCES `aluno` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_aluno_sala_sala`
    FOREIGN KEY (`sala_id`)
    REFERENCES `sala` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `sala_trilha` (
  `sala_id` INT NOT NULL,
  `trilha_id` INT NOT NULL,
  PRIMARY KEY (`sala_id`, `trilha_id`),
  INDEX `fk_sala_trilha_sala_idx` (`sala_id` ASC) VISIBLE,
  INDEX `fk_sala_trilha_trilha_idx` (`trilha_id` ASC) VISIBLE,
  CONSTRAINT `fk_sala_trilha_sala`
    FOREIGN KEY (`sala_id`)
    REFERENCES `sala` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_sala_trilha_trilha`
    FOREIGN KEY (`trilha_id`)
    REFERENCES `trilha` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

CREATE TABLE IF NOT EXISTS `desempenho_jogo` (
  `id` INT NOT NULL AUTO_INCREMENT,
  `aluno_id` INT NOT NULL,
  `jogo_id` INT NOT NULL,
  `trilha_id` INT NOT NULL,
  `sala_id` INT NOT NULL,
  `data_hora` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `passou` BOOLEAN NOT NULL,
  `acertos` JSON NULL,
  `erros` JSON NULL,
  PRIMARY KEY (`id`),
  INDEX `fk_desempenho_aluno_idx` (`aluno_id` ASC) VISIBLE,
  INDEX `fk_desempenho_jogo_idx` (`jogo_id` ASC) VISIBLE,
  INDEX `fk_desempenho_trilha_idx` (`trilha_id` ASC) VISIBLE,
  INDEX `fk_desempenho_sala_idx` (`sala_id` ASC) VISIBLE,
  CONSTRAINT `fk_desempenho_aluno`
    FOREIGN KEY (`aluno_id`)
    REFERENCES `aluno` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_desempenho_jogo`
    FOREIGN KEY (`jogo_id`)
    REFERENCES `jogo` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE,
  CONSTRAINT `fk_desempenho_trilha`
    FOREIGN KEY (`trilha_id`)
    REFERENCES `trilha` (`id`)
    ON DELETE RESTRICT
    ON UPDATE CASCADE,
  CONSTRAINT `fk_desempenho_sala`
    FOREIGN KEY (`sala_id`)
    REFERENCES `sala` (`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;